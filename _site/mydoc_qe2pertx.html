<!DOCTYPE html>
<html lang="en">
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Quantum Espresso to PERTURBO  | Perturbo | Manual</title>


<link rel="stylesheet" href="http://localhost:4010/mydoc-pdf/css/syntax.css">
<link rel="stylesheet" href="http://localhost:4010/mydoc-pdf/css/font-awesome.min.css">
<link rel="stylesheet" href="http://localhost:4010/mydoc-pdf/css/bootstrap.min.css">
<link rel="stylesheet" href="http://localhost:4010/mydoc-pdf/css/modern-business.css">
<link rel="stylesheet" href="http://localhost:4010/mydoc-pdf/css/customstyles.css">
<link rel="stylesheet" href="http://localhost:4010/mydoc-pdf/css/theme-blue.css">
<link rel="stylesheet" href="http://localhost:4010/mydoc-pdf/css/syntax.css">
<link rel="stylesheet" href="/mydoc-pdf/css/printstyles.css">

<script>
    Prince.addScriptFunc("datestamp", function() {
        return "PDF last generated: January 01, 2020";
    });
</script>

<script>
    Prince.addScriptFunc("guideName", function() {
        return "Perturbo User Guide";
    });
</script>



</head>

<body class=" print">

<!-- Page Content -->
<div class="container">
    <!-- Content Column -->
    <div class="col-md-9">

        <div class="post-header">
    <h1 class="post-title-main" id="mydoc_qe2pertx.html">Quantum Espresso to PERTURBO</h1>
</div>

<div class="post-content">

    
    <p>Before running electron dynamics calculations using pertubo.x, the user needs to carry out electronic and phonon calculations, with DFT and DFPT respectively. At present, Perturbo can read the output of DFT and DFPT calculations done with Quantum Espresso (QE). Once the relevant output files have been obtained from QE, the first step is to use qe2pert.x to compute the e-ph matrix elements on a coarse k- and q-point Brillouin zone grid, and to store the data into the HDF5 format for perturbo.x to read. The generation of this HDF5 file, called <em>prefix_epwan.h5</em>, is discussed in this section of the manual.</p>

<p>The preparation stage consists of five steps:</p>

<ol>
  <li>Run a self-consistent (scf) DFT calculation</li>
  <li>Run a phonon calculation using DFPT</li>
  <li>Run a non-scf (nscf) DFT calculation</li>
  <li>Run Wannier90 to obtain Wannier functions</li>
  <li>Run qe2pert.x</li>
</ol>

<p>In the following, we use silicon as an example. The input files for QE and W90 are in the directory “examples-perturbo/example02-silicon-qe2pert/pw-ph-wann”. As a reference, we also provide the results in a directory called “reference”.</p>

<h3 id="step-1-scf-calculation">Step 1: scf calculation</h3>

<div class="alert alert-warning" role="alert"><i class="fa fa-folder"></i> <b>Directory:</b> examples/example02-silicon-qe2pert/pw-ph-wan/scf </div>

<p>Run an SCF calculation and obtain the QE prefix.save directory. In this case, we obtain ./tmp/si.save, which is needed for phonon and nscf calculations.</p>

<h3 id="step-2-phonon-calculation">Step 2: phonon calculation</h3>

<div class="alert alert-warning" role="alert"><i class="fa fa-folder"></i> <b>Directory:</b> examples/example02-silicon-qe2pert/pw-ph-wan/phonon</div>

<p>We provide an example input file  <em>ph-ref.in</em> for phonon calculations in QE, and two shell scripts (<em>ph-submit.sh</em> and <em>ph-collect.sh</em>) to set up and run a separate phonon calculation for each q-point and collect the results. The user can modify the reference input file and the two shell scripts to use them for their material of choice and on their computing system. In this step, make sure that the number of q-points is commensurate with the number of k-points used in the nscf and Wannierization calculations. For example, a q-grid of 8x8x8 can be used with a wannierization k-grid of 8x8x8 or 16x16x16, but not with a 10x10x10 or 12x12x12 grid.</p>

<p>Remember to copy the QE prefix.save directory from the scf run to the current directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp -r ../scf/tmp ./
</code></pre></div></div>

<p>To obtain the number of irreducible q-points in the phonon calculation, edit the <em>ph-submit</em> file and set <code class="language-plaintext highlighter-rouge">mode='gamma'</code> to run a Gamma-point phonon calculation.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vim ph-submit.sh
......
set mode='gamma'
......
$ ./ph-submit
</code></pre></div></div>

<p>The shell script creates a directory called <em>ph-1</em>. Change into that directory and open the file <em>ph.out</em> to read the number of irreducible q-points in the phonon calculation.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd ph-1
$ vi ph.out
</code></pre></div></div>

<p>In our silicon example, the total number of q-points is 29. It is fine to forgo the previous step and obtain the number of q-points some other way. Once this information is available, open again the shell script <em>ph-submit</em>. Change the starting number from 1 to 2 and the final number to the total number of irreducible q-points.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vi ph-submit.sh
......
change (NQ=1; NQ&lt;=8; NQ++) to (NQ=2; NQ&lt;=29; NQ++)
......
$ ./ph-submit
</code></pre></div></div>

<p>The shell script creates one directory (<em>ph-#</em>) for each q-point. Once the calculations are done, we collect all the phonon data into a directory called <em>save</em>, created by running the shell script <em>ph-collect.sh</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./ph-collect.sh
</code></pre></div></div>

<p>The <em>save</em> directory contains all the information needed for PETURBO to interface with QE. These include the dynamical matrix files, phonon perturbation potentials, and the patterns.</p>

<p>The reference input file and scripts can be modified to run calculations for different materials. We recommend the user to become familiar with phonon calculations in QE to perform this step.</p>

<p>Since phonon calculations using DFPT can be  computationally expensive, it is often useful to estimate the number of irreducible q-points before running the phonon calculation. Note however that this step is optional.</p>

<h3 id="step-3-nscf-calculation">Step 3: nscf calculation</h3>

<div class="alert alert-warning" role="alert"><i class="fa fa-folder"></i> <b>Directory:</b> examples/example02-silicon-qe2pert/pw-ph-wan/nscf</div>

<p>We now run the nscf calculations needed to generate the wavefunctions on the full k-point grid, which we’ll need both for generating Wannier functions with Wannier90 and for forming the coarse-grid e-ph matrix elements in Perturbo. Make sure that the number of k points is commensurate with the number of q-points used for phonons, otherwise, qe2pert.x will stop. Remember to copy the QE prefix.save directory from the scf calculation the current directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp -r ../scf/tmp ./
</code></pre></div></div>

<p>Then run the nscf calculation with QE.</p>

<h3 id="step-4-wannier90-calculation">Step 4: Wannier90 calculation</h3>

<div class="alert alert-warning" role="alert"><i class="fa fa-folder"></i> <b>Directory:</b> examples/example02-silicon-qe2pert/pw-ph-wan/wann</div>

<p>The directory contains two input files, one for wannier.x and the other for pw2wannier90.x. In the input file <em>si.win</em>, we instruct Wannier90 to write two important quantities for qe2pert.x, the $U^(\bm{k})$, $U^(\text{dis}\bm{k})$ matrices and the position of the Wannier function centers, using: <em>write_u_matrices=true</em> and <em>write_xyz=true</em>.</p>

<p>We create tmp directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir tmp
</code></pre></div></div>

<p>and change into it. We soft link to the QE prefix.save directory obtained in the nscf calculation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd tmp
$ ln -sf ../../nscf/tmp/si.save 
</code></pre></div></div>

<p>We then run Wannier90. The important output files for qe2pert.x are <em>si_u.mat</em>, <em>si_u_dis.mat</em>, and <em>si_centres.xyz</em>. For disentangled bands, there would be no <em>prefix_u_dis.mat</em>. We encourage the user to become familiar with Wannier90 to run this step for different materials.</p>

<p>The user has to run Wannier90 3.0 or higher, since otherwise the U matrices cannot be printed out.</p>

<h3 id="step-5-running-qe2pertx">Step 5: Running qe2pert.x</h3>

<div class="alert alert-warning" role="alert"><i class="fa fa-folder"></i> <b>Directory:</b> examples/example02-silicon-qe2pert/qe2pert</div>

<p>We are ready to compute the e-ph matrix elements on the coarse k-point (determined by the nscf step) and q-point (determined by the phonon step) Brillouin zone grids. First, copy or link the electronic and phonon calculation results to the current directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd qe2pert
$ mkdir tmp
$ cd tmp 

link to the nscf .save directory
$ ln -sf ../../pw-ph-wann/nscf/tmp/si.save
$ cd ../

link to the wannier information
$ ln -sf ../wann/si_u.mat
$ ln -sf ../wann/si_u_dis.mat
$ ln -sf ../wann/si_centres.xyz
</code></pre></div></div>

<p>Here we show the input file for the executable qe2pert.x:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&amp;qe2pert
 prefix='si'
 outdir='./tmp'
 phdir='../pw-ph-wann/phonon/save'
 nk1=8, nk2=8, nk3=8
 qe_band_min = 1
 qe_band_max = 16
 num_wann = 8
 lwannier=.true.
/ 
</code></pre></div></div>

<ul>
  <li><em>prefix</em> needs to be the same as the prefix used in the input files for QE.</li>
  <li><em>outdir</em> contains the save directroy obtained from the nscf calculations. The calculated e-ph matrix elements will be stored in this directory.</li>
  <li><em>phdir</em> is the save directory inside which we collected all the phonon information.</li>
  <li><em>nk1</em>, <em>nk2</em>, <em>nk3</em> are the number of k-points along each direction used in the nscf and Wannier90 calculations.</li>
  <li><em>qe_band_min</em> and <em>qe_band_max</em> determine the range of bands we are interested in, and should be the same as the values used in the Wannierization process. For example, if we used 40 bands in the nscf calculation and we excluded bands 1-4 and 31-40 in the Wannierization, then <em>qe_band_min=5</em> and  <em>qe_band_max=30</em>.</li>
  <li><em>num_wann</em>: the number of Wannier functions.</li>
  <li><em>lwannier</em>: a logical flag. When it is .true., the e-ph matrix elements are computed using the Bloch wave functions rotated with the Wannier unitary matrix; if .false., the e-ph matrix elements are computed using  the Bloch wave functions, and the e-ph matrix elements are then rotated using the Wannier unitary matrix. Set it to .true. to reduce computational cost.</li>
  <li><em>system_2d</em>: if the materials is two-dimensional, so that in one direction only one k-point is used, set it to .true.; the default is .false.</li>
</ul>

<p>Now we are ready to run the e-ph matrix elements:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export OMP_NUM_THREADS=1
$ mpirun -n 1 qe2pert.x -npools 1 -i qe2pert.in &gt; qe2pert.out
</code></pre></div></div>

<p>The executables perturbo.x and qe2pert.x employ hybrid parallelization (MPI plus OpenMP). To speed up the calculations, the user can can increase the number of OpenMP threads and MPI processes.</p>

<p>Note that the number of pools (-npools) has to be equal to the number of MPI processes (-np or -n), otherwise the code will stop. This task takes 8 hours on a single core, but it can be made much faster (minutes) using MPI plus OpenMP. We particularly recommend using threads with OpenMP (usually, setting OMP_NUM_THREADS= half the value of cores per node is a good choice). (**Jin-Jian, can you revise these statements? **) . Once the calcalculation has completed, we obtain the output file <em>si_epwan.h5</em>, which is an HDF5 database with all the information needed to run perturbo.x.</p>


</div>

    </div>

</div>    <!-- /.container -->

</body>

</html>

